<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">


<mapper namespace="org.example.finalproject.demos.mapper.UserMapper">
    <resultMap id="BaseResultMap" type="User">
        <id column="id" property="id"/>
        <result column="username" property="username"/>
        <result column="password" property="password"/>
        <result column="nickname" property="nickname"/>
        <result column="email" property="email"/>
        <result column="phone" property="phone"/>
        <result column="status" property="status"/>
    </resultMap>

    <resultMap id="UserWithRolesResultMap" type="User" extends="BaseResultMap">
        <collection property="roles" ofType="Role">
            <id column="role_id" property="id"/>
            <result column="role_name" property="roleName"/>
            <result column="role_code" property="roleCode"/>

            <collection property="permissions" ofType="Permission">
                <id column="permission_id" property="id"/>
                <result column="permission_name" property="permissionName"/>
                <result column="permission_code" property="permissionCode"/>
                <result column="url" property="url"/>
                <result column="method" property="method"/>
            </collection>
        </collection>
    </resultMap>

    <select id="selectByUsername" parameterType="string" resultMap="BaseResultMap">
        SELECT * FROM sys_user WHERE username=#{username}
    </select>

    <select id="selectUserRoles" resultMap="UserWithRolesResultMap">
        SELECT u.*, r.id role_id, r.role_name, r.role_code,
               p.id permission_id, p.permission_name, p.permission_code, p.url, p.method
        FROM sys_user u
                 LEFT JOIN sys_user_role ur ON u.id=ur.user_id
                 LEFT JOIN sys_role r ON ur.role_id=r.id
                 LEFT JOIN sys_role_permission rp ON r.id=rp.role_id
                 LEFT JOIN sys_permission p ON rp.permission_id=p.id
        WHERE u.id=#{userId}
    </select>

    <select id="selectAllUsers" resultMap="BaseResultMap">
        SELECT * FROM sys_user ORDER BY id DESC
    </select>

    <select id="selectById" parameterType="long" resultMap="BaseResultMap">
        SELECT * FROM sys_user WHERE id=#{id}
    </select>

    <insert id="insert" parameterType="User" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO sys_user(username,password,nickname,email,phone,status)
        VALUES(#{username},#{password},#{nickname},#{email},#{phone},#{status})
    </insert>

    <update id="update" parameterType="User">
        UPDATE sys_user SET nickname=#{nickname}, email=#{email},
                            phone=#{phone}, status=#{status} WHERE id=#{id}
    </update>

    <delete id="delete">
        DELETE FROM sys_user WHERE id=#{id}
    </delete>

    <delete id="deleteUserRoles">
        DELETE FROM sys_user_role WHERE user_id=#{userId}
    </delete>

    <insert id="batchInsertUserRoles">
        INSERT INTO sys_user_role(user_id,role_id)
        VALUES
        <foreach collection="roleIds" item="roleId" separator=",">
            (#{userId}, #{roleId})
        </foreach>
    </insert>

    <select id="countByEmail" parameterType="string" resultType="int">
        SELECT COUNT(*) FROM sys_user WHERE email=#{email}
    </select>
</mapper>